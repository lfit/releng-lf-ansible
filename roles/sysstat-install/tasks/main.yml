---
- name: Install sysstat service
  block:
    - name: Install sysstat package
      package:
        name: sysstat
        state: present
    - name: Enable sysstat service
      service:
        name: sysstat
        enabled: true
  become: true

- name: Configure sysstat on deb based system
  block:
    - name: Enable sysstat in /etc/default/sysstat
      lineinfile:
        path: /etc/default/sysstat
        regexp: '^ENABLED='
        line: 'ENABLED="true"'
        create: true
    - name: Set frequency to 1 minute
      lineinfile:
        path: /etc/cron.d/sysstat
        regexp: '((.*\/)(10)([ \*]+))(\s+.*)(debian-sa1.*)'
        line: '*/1\g<4>\g<5>\g<6>'
        backrefs: true
    - name: Restart sysstat service
      service:
        name: sysstat
        state: restarted
  when: ansible_os_family == 'Debian'
  become: true

- name: Configure sysstat on rpm based system
  block:
    - name: Set frequency to 1 minute
      lineinfile:
        path: /etc/cron.d/sysstat
        regexp: '((.*\/)(10)([ \*]+))(\s+.*)(sa1.*)'
        line: '\g<2>1\g<4>\g<5>\g<6>'
        backrefs: true
    - name: Restart sysstat service
      service:
        name: sysstat
        state: restarted
  when: ansible_os_family == 'RedHat'
  become: true
